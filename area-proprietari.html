<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Area proprietari – B&Brother’s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="site-header">
  <div class="container header-inner fade-in">
    <a href="index.html" class="logo">
      <img src="logo-bbrothers.png" alt="Logo B&Brother’s" class="logo-img" />
      <div class="logo-text">
        <span class="logo-title">B&Brother’s</span>
        <span class="logo-subtitle">Gestione affitti brevi a Roma</span>
      </div>
    </a>
    <nav class="main-nav">
      <a href="index.html" class="nav-link">Home</a>
        <a href="proprietari.html" class="nav-link">Per i proprietari</a>
        <a href="ospiti.html" class="nav-link">Per gli ospiti</a>
        <a href="alloggi.html" class="nav-link">Alloggi</a>
        <a href="come-lavoriamo.html" class="nav-link">Come lavoriamo</a>
        <a href="chi-siamo.html" class="nav-link">Chi siamo</a>
        <a href="faq.html" class="nav-link">FAQ</a>
        <a href="contatti.html" class="nav-link">Contatti</a>
        <a href="login.html" class="nav-link nav-link-active">Area proprietari</a>
        
    </nav>
    <a href="https://wa.me/393345071226" class="btn btn-whatsapp">WhatsApp</a>
  </div>
</header>

<main>

<section class="page-hero">
  <div class="container fade-in">
    <p class="eyebrow">Area proprietari</p>
    <h1>Le tue strutture</h1>
    <p class="page-hero-subtitle">
      Qui puoi vedere e creare gli annunci delle tue strutture. In questa prima versione gli annunci vengono salvati come bozze.
    </p>
  </div>
</section>

<section class="section section-light">
  <div class="container">
    <button id="btn-logout" class="btn btn-outline" style="margin: 10px 0;">Logout</button>

    <section style="margin-top: 20px;">
      <h2>Le tue strutture</h2>
      <div id="my-properties"></div>
    </section>

    <hr style="margin: 24px 0;">

    <section>
      <h2>Nuova struttura (bozza)</h2>
      <form id="new-property-form" class="contact-form">
        <label>
          Titolo
          <input type="text" id="prop-title" required />
        </label>
        <label>
          Zona
          <input type="text" id="prop-zone" />
        </label>
        <label>
          Descrizione breve
          <textarea id="prop-short" rows="2"></textarea>
        </label>
        <label>
          Descrizione completa
          <textarea id="prop-full" rows="4"></textarea>
        </label>
        <label>
          Posti letto
          <input type="number" id="prop-guests" />
        </label>
        <label>
          Prezzo base (€/notte)
          <input type="number" id="prop-price" step="0.01" />
        </label>
        <label>
          Foto di copertina
          <input type="file" id="prop-cover" accept="image/*" />
        </label>
        <button type="submit" class="btn btn-primary btn-full">Salva struttura (bozza)</button>
      </form>
      <p id="prop-message" class="small-label"></p>
    </section>
  </div>
</section>

</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <p>© 2025 B&Brother’s – Gestione Affitti Brevi a Roma. Tutti i diritti riservati.</p>
    <p>WhatsApp: +39 334 507 1226 · Email: a.paolino0104@gmail.com</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://qmsgcpkxdkijsxyvhuog.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtc2djcGt4ZGtpanN4eXZodW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjQ1MzcsImV4cCI6MjA3ODkwMDUzN30.husS5qI2XxYqovnx3QX-EPFPca4SPWRQQo9rHM8NLEE";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<script>
  async function getCurrentUser() {
    const { data, error } = await supabase.auth.getUser();
    if (error || !data.user) {
      window.location.href = "login.html";
      return null;
    }
    return data.user;
  }

  let currentUser = null;

  document.getElementById("btn-logout").addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  });

  async function loadMyProperties() {
    const listEl = document.getElementById("my-properties");
    listEl.innerHTML = "Caricamento...";

    const { data, error } = await supabase
      .from("properties")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      listEl.innerHTML = "Errore nel caricamento: " + error.message;
      return;
    }

    if (!data || data.length === 0) {
      listEl.innerHTML = "<p>Non hai ancora strutture.</p>";
      return;
    }

    listEl.innerHTML = data
      .map(
        (p) => `
        <article class="listing-card">
          <h3>${p.title}</h3>
          <p>${p.short_description || ""}</p>
          <p class="small-label">Stato: <strong>${p.status}</strong></p>
        </article>
      `
      )
      .join("");
  }

  async function handleNewProperty(e) {
    e.preventDefault();
    const msg = document.getElementById("prop-message");
    msg.textContent = "Salvataggio in corso...";

    const title = document.getElementById("prop-title").value;
    const zone = document.getElementById("prop-zone").value;
    const shortDesc = document.getElementById("prop-short").value;
    const fullDesc = document.getElementById("prop-full").value;
    const guests = parseInt(document.getElementById("prop-guests").value || "0", 10);
    const price = parseFloat(document.getElementById("prop-price").value || "0");
    const coverFile = document.getElementById("prop-cover").files[0];

    const { data: propData, error: propError } = await supabase
      .from("properties")
      .insert({
        owner_id: currentUser.id,
        title,
        zone,
        short_description: shortDesc,
        full_description: fullDesc,
        guests,
        base_price: price,
        status: "draft"
      })
      .select()
      .single();

    if (propError) {
      msg.textContent = "Errore salvataggio struttura: " + propError.message;
      return;
    }

    if (coverFile) {
      const path = `${currentUser.id}/${propData.id}/${coverFile.name}`;
      const { error: uploadError } = await supabase.storage
        .from("property-photos")
        .upload(path, coverFile);

      if (uploadError) {
        msg.textContent = "Struttura creata, ma errore upload foto: " + uploadError.message;
      } else {
        const { data: publicData } = supabase.storage
          .from("property-photos")
          .getPublicUrl(path);
        const coverUrl = publicData.publicUrl;

        await supabase
          .from("properties")
          .update({ cover_photo_url: coverUrl })
          .eq("id", propData.id);

        msg.textContent = "Struttura salvata in bozza con foto.";
      }
    } else {
      msg.textContent = "Struttura salvata in bozza.";
    }

    document.getElementById("new-property-form").reset();
    loadMyProperties();
  }

  document.getElementById("new-property-form").addEventListener("submit", handleNewProperty);

  (async () => {
    currentUser = await getCurrentUser();
    if (!currentUser) return;
    loadMyProperties();
  })();
</script>

</body>
</html>