<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Login fornitori – B&Brother’s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
<header class="site-header">
  <div class="container header-inner fade-in">
    <a href="index.html" class="logo">
      <img src="assets/images/logo-bbrothers.png" alt="Logo B&Brother’s" class="logo-img" />
      <div class="logo-text">
        <span class="logo-title">B&Brother’s</span>
        <span class="logo-subtitle">Accesso fornitori</span>
      </div>
    </a>
    <nav class="main-nav"></nav>
    <span class="nav-link nav-link-ghost" aria-hidden="true">Area riservata</span>
  </div>
</header>

<main>
  <section class="page-hero">
    <div class="container fade-in">
      <p class="eyebrow">Fornitori</p>
      <h1>Accedi per gestire i servizi extra</h1>
      <p class="page-hero-subtitle">Login email/password dedicato a chi offre servizi aggiuntivi per gli ospiti.</p>
    </div>
  </section>

  <section class="section section-light">
    <div class="container auth-card">
      <form id="provider-login-form" class="auth-form">
        <label>
          Email
          <input type="email" id="login-email" required placeholder="fornitore@email.com" />
        </label>
        <label>
          Password
          <input type="password" id="login-password" required placeholder="••••••••" />
        </label>
        <button type="submit" class="btn btn-primary btn-full">Login</button>
        <p id="login-message" class="small-label"></p>
      </form>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <p>© 2025 B&Brother’s – Gestione Affitti Brevi a Roma. Tutti i diritti riservati.</p>
    <p>WhatsApp: +39 334 507 1226 · Email: a.paolino0104@gmail.com</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://qmsgcpkxdkijsxyvhuog.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtc2djcGt4ZGtpanN4eXZodW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjQ1MzcsImV4cCI6MjA3ODkwMDUzN30.husS5qI2XxYqovnx3QX-EPFPca4SPWRQQo9rHM8NLEE";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script>
  const form = document.getElementById("provider-login-form");
  const msgEl = document.getElementById("login-message");

  async function redirectIfAlreadyLogged() {
    const { data } = await supabase.auth.getUser();
    if (data?.user) {
      const provider = await fetchProvider(data.user.id);
      if (provider) {
        window.location.href = "fornitore-dashboard.html";
      }
    }
  }

  async function fetchProvider(userId) {
    const { data, error } = await supabase.from("providers").select("*").eq("user_id", userId).single();
    if (error || !data) return null;
    return data;
  }

  async function handleLogin(e) {
    e.preventDefault();
    msgEl.textContent = "Verifica in corso...";

    const email = document.getElementById("login-email").value.trim();
    const password = document.getElementById("login-password").value.trim();

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error || !data.user) {
      msgEl.textContent = "Credenziali non valide. Riprova.";
      return;
    }

    const provider = await fetchProvider(data.user.id);
    if (!provider) {
      msgEl.textContent = "Nessun profilo fornitore associato a questo account.";
      await supabase.auth.signOut();
      return;
    }

    msgEl.textContent = "Accesso riuscito, reindirizzamento...";
    window.location.href = "fornitore-dashboard.html";
  }

  form.addEventListener("submit", handleLogin);
  redirectIfAlreadyLogged();
</script>
</body>
</html>
