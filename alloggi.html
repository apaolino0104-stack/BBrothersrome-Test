<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Alloggi – B&Brother’s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
<header class="site-header">
  <div class="container header-inner fade-in">
    <a href="ospiti.html" class="logo">
      <img src="assets/images/logo-bbrothers.png" alt="Logo B&Brother’s" class="logo-img" />
      <div class="logo-text">
        <span class="logo-title">B&Brother’s</span>
        <span class="logo-subtitle">Gestione affitti brevi a Roma</span>
      </div>
    </a>
    <input type="checkbox" id="nav-toggle" class="nav-toggle" aria-label="Apri il menu" />
    <label for="nav-toggle" class="menu-toggle">
      <span class="menu-toggle-box">
        <span class="menu-toggle-line"></span>
        <span class="menu-toggle-line"></span>
        <span class="menu-toggle-line"></span>
      </span>
      <span class="menu-toggle-text">Menu</span>
    </label>
    <nav class="main-nav">
      <a href="ospiti.html" class="nav-link">Home ospiti</a>
      <a href="alloggi.html" class="nav-link nav-link-active">Tutti gli alloggi</a>
      <a href="servizi-extra.html" class="nav-link">Servizi extra</a>
      <a href="ospiti.html#come-funziona-ospiti" class="nav-link">Come funziona</a>
      <a href="contatti.html" class="nav-link">Contatti</a>
    </nav>
    <a href="proprietari.html" class="nav-link nav-link-ghost">Sei un proprietario?</a>
  </div>
</header>

<main>

<section class="page-hero">
  <div class="container fade-in">
    <p class="eyebrow">Alloggi</p>
    <h1>I nostri appartamenti a Roma</h1>
    <p class="page-hero-subtitle">
      Una selezione di alloggi curati, in zone strategiche della città.
      Contattaci su WhatsApp per disponibilità e preventivi aggiornati.
    </p>
  </div>
</section>

<section class="section section-light">
  <div class="container">
    <div class="filter-bar fade-in delay-1">
      <div class="filter-search" role="search">
        <label class="filter-label" for="alloggi-search">Cerca:</label>
        <input
          type="search"
          id="alloggi-search"
          class="filter-search-input"
          placeholder="Cerca un alloggio per nome o zona"
          aria-label="Cerca un alloggio per nome o zona"
        />
      </div>
      <span class="filter-label">Filtra per:</span>
      <select id="filter-zone" class="filter-select">
        <option value="">Tutte le zone</option>
      </select>
      <select id="filter-guests" class="filter-select">
        <option value="">Tutti i posti letto</option>
      </select>
      <select id="filter-type" class="filter-select">
        <option value="">Tutte le tipologie</option>
      </select>
    </div>

    <div id="public-properties" class="cards-grid listings-grid">
      <!-- riempito da Supabase -->
    </div>

    <p class="note fade-in delay-3" id="public-note"></p>
  </div>
</section>

</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <p>© 2025 B&Brother’s – Gestione Affitti Brevi a Roma. Tutti i diritti riservati.</p>
    <p>WhatsApp: +39 334 507 1226 · Email: a.paolino0104@gmail.com</p>
  </div>
</footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (() => {
      const SUPABASE_URL = "https://qmsgcpkxdkijsxyvhuog.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtc2djcGt4ZGtpanN4eXZodW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjQ1MzcsImV4cCI6MjA3ODkwMDUzN30.husS5qI2XxYqovnx3QX-EPFPca4SPWRQQo9rHM8NLEE";
      const PHOTO_BUCKET = "property-photos";
      const supabaseClientAlloggi = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      function publicUrlFromPath(path) {
        if (!path) return null;
        if (path.startsWith("http")) return path;
        const { data } = supabaseClientAlloggi.storage.from(PHOTO_BUCKET).getPublicUrl(path);
        return data?.publicUrl || null;
      }

      const listEl = document.getElementById("public-properties");
      const noteEl = document.getElementById("public-note");
      const searchInput = document.getElementById("alloggi-search");
      const zoneSelect = document.getElementById("filter-zone");
      const guestsSelect = document.getElementById("filter-guests");
      const typeSelect = document.getElementById("filter-type");

      const state = {
        properties: [],
        filters: {
          search: "",
          zone: "",
          guests: "",
          type: "",
        },
      };

      function getPropertyType(prop) {
        return (prop.property_type || prop.typology || prop.type || "").trim();
      }

      function renderPropertyCard(property) {
        const coverPhoto = property.property_photos?.find((p) => p.is_cover) || property.property_photos?.[0];
        const coverUrl = coverPhoto ? publicUrlFromPath(coverPhoto.path) : null;
        const photoMarkup =
          coverUrl != null
            ? `<img src="${coverUrl}" alt="${property.title || "Alloggio"}" loading="lazy" />`
            : `<div class="photo-placeholder">Nessuna foto</div>`;

        const price = property.price_per_night != null ? `${property.price_per_night} € / notte` : "Prezzo su richiesta";
        const address = [property.address_line1, property.zone, property.city].filter(Boolean).join(", ");
        const propType = getPropertyType(property);
        const guests = property.guests != null ? `${property.guests} ospiti` : "Capienza non indicata";

        return `
          <article class="card property-card">
            <div class="property-photo">${photoMarkup}</div>
            <div class="property-info">
              <div class="eyebrow">${propType || "Alloggio"} · ${guests}</div>
              <h3>${property.title || "Proprietà"}</h3>
              <p class="text-strong">${address || "Roma"}</p>
              <p>${property.short_description || "Scopri i dettagli dell'alloggio."}</p>
              <p class="price">${price}</p>
              <a class="btn btn-primary" href="property.html?id=${property.id}">Scopri l'alloggio</a>
            </div>
          </article>
        `;
      }

      function renderProperties(list) {
        if (!listEl) return;

        if (!list || list.length === 0) {
          listEl.innerHTML = `<p class="empty">Nessun alloggio trovato. Prova a cambiare i filtri.</p>`;
          return;
        }

        listEl.innerHTML = list.map((prop) => renderPropertyCard(prop)).join("");
      }

      function populateFilterOptions(properties) {
        const zones = new Set();
        const guestsOptions = new Set();
        const types = new Set();

        properties.forEach((property) => {
          if (property.zone) zones.add(property.zone);
          if (property.guests) guestsOptions.add(property.guests);
          const propType = getPropertyType(property);
          if (propType) types.add(propType);
        });

        zoneSelect.innerHTML = `<option value="">Tutte le zone</option>${Array.from(zones)
          .sort()
          .map((zone) => `<option value="${zone}">${zone}</option>`)
          .join("")}`;

        guestsSelect.innerHTML = `<option value="">Tutti</option>${Array.from(guestsOptions)
          .sort((a, b) => a - b)
          .map((num) => `<option value="${num}">${num} ospiti</option>`)
          .join("")}`;

        typeSelect.innerHTML = `<option value="">Tutti i tipi</option>${Array.from(types)
          .sort()
          .map((type) => `<option value="${type}">${type}</option>`)
          .join("")}`;
      }

      function matchesFilters(property) {
        const { search, zone, guests, type } = state.filters;
        const normalizedSearch = search.toLowerCase().trim();

        const matchesSearch =
          !normalizedSearch ||
          [property.title, property.zone, property.short_description]
            .some((field) => (field || "").toLowerCase().includes(normalizedSearch));

        const matchesZone = !zone || (property.zone || "").toLowerCase() === zone.toLowerCase();
        const matchesGuests = !guests || String(property.guests || "") === guests;
        const propType = getPropertyType(property);
        const matchesType = !type || propType.toLowerCase() === type.toLowerCase();

        return matchesSearch && matchesZone && matchesGuests && matchesType;
      }

      function applyFilters() {
        if (!state.properties.length) {
          renderProperties([]);
          return;
        }

        const filtered = state.properties.filter((prop) => matchesFilters(prop));
        renderProperties(filtered);
      }

      async function loadPublicProperties() {
        if (!listEl) return;
        listEl.innerHTML = "<p>Caricamento alloggi...</p>";

        const { data, error } = await supabaseClientAlloggi
          .from("properties")
          .select("*, property_photos(path,is_cover,sort_order)")
          .eq("status", "published")
          .order("created_at", { ascending: false });

        if (error) {
          console.error(error);
          listEl.innerHTML = "<p>Errore nel caricamento degli alloggi.</p>";
          return;
        }

        state.properties = Array.isArray(data) ? data : [];
        populateFilterOptions(state.properties);
        applyFilters();
      }

      loadPublicProperties();

      searchInput?.addEventListener("input", (event) => {
        state.filters.search = event.target.value;
        applyFilters();
      });

      zoneSelect?.addEventListener("change", (event) => {
        state.filters.zone = event.target.value;
        applyFilters();
      });

      guestsSelect?.addEventListener("change", (event) => {
        state.filters.guests = event.target.value;
        applyFilters();
      });

      typeSelect?.addEventListener("change", (event) => {
        state.filters.type = event.target.value;
        applyFilters();
      });
    })();
  </script>

</body>
</html>
