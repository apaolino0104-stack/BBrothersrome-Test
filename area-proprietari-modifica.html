<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <title>Modifica propriet√† ‚Äì B&Brother‚Äôs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="icon" type="image/png" href="assets/images/logo-bbrothers.png" />
</head>

<body>
  <header class="site-header">
    <div class="container header-inner fade-in">
      <a href="proprietari.html" class="logo">
        <img src="assets/images/logo-bbrothers.png" alt="Logo B&Brother‚Äôs" class="logo-img" />
        <div class="logo-text">
          <span class="logo-title">B&Brother‚Äôs</span>
          <span class="logo-subtitle">Gestione affitti brevi a Roma</span>
        </div>
      </a>
      <input type="checkbox" id="nav-toggle" class="nav-toggle" aria-label="Apri il menu" />
      <label for="nav-toggle" class="menu-toggle">
        <span class="menu-toggle-box">
          <span class="menu-toggle-line"></span>
          <span class="menu-toggle-line"></span>
          <span class="menu-toggle-line"></span>
        </span>
        <span class="menu-toggle-text">Menu</span>
      </label>
      <nav class="main-nav">
        <a href="proprietari.html" class="nav-link">Home proprietari</a>
        <a href="proprietari.html#come-funziona" class="nav-link">Come funziona</a>
        <a href="proprietari.html#servizi-proprietari" class="nav-link">Servizi</a>
        <a href="proprietari.html#commissione" class="nav-link">Commissione</a>
        <a href="contatti.html" class="nav-link">Contatti</a>
        <a href="login.html" class="nav-link nav-link-active">üîë Area proprietari</a>
      </nav>
      <a href="ospiti.html" class="nav-link nav-link-ghost">Vuoi prenotare un soggiorno?</a>
    </div>
  </header>

  <main>
    <section class="page-hero">
      <div class="container fade-in">
        <p class="eyebrow">Area proprietari</p>
        <h1 id="page-title">Modifica propriet√†</h1>
        <p class="page-hero-subtitle">Aggiorna testi, prezzi, stato e gestisci tutte le foto dalla galleria con
          copertina e miniature.</p>
      </div>
    </section>

    <section class="section section-light">
      <div class="container">
        <div class="section-header">
          <div>
            <p class="eyebrow" style="color: var(--text-muted);">Modifica</p>
            <h2 id="prop-name">Caricamento...</h2>
            <p class="section-subtitle">Accedi ai dettagli completi dell'annuncio e aggiungi nuove foto. Le miniature
              mostrano tutte le immagini salvate.</p>
          </div>
          <a href="area-proprietari.html" class="btn btn-outline">‚Üê Torna alle strutture</a>
        </div>

        <!-- Room Section (Only for Guest House) -->
        <div id="rooms-section"
          style="display: none; margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
          <div class="section-header" style="margin-bottom: 1rem;">
            <h3 style="margin:0;">Stanze della Guest House</h3>
            <a id="btn-add-room" href="#" class="btn btn-primary btn-small">+ Aggiungi Stanza</a>
          </div>
          <div id="rooms-list" class="cards-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
            <!-- Rooms loaded here -->
          </div>
        </div>

        <div id="edit-photos" class="gallery-viewer" style="margin: 12px 0;"></div>

        <form id="edit-property-form" class="contact-form">
          <label>
            Titolo
            <input type="text" id="edit-title" required />
          </label>
          <label>
            Zona
            <input type="text" id="edit-zone" />
          </label>
          <label>
            Descrizione breve
            <textarea id="edit-short" rows="2"></textarea>
          </label>
          <label>
            Descrizione completa
            <textarea id="edit-full" rows="4"></textarea>
          </label>
          <div class="two-cols">
            <label>
              Posti letto
              <input type="number" id="edit-guests" />
            </label>
            <label>
              Prezzo base (‚Ç¨/notte)
              <input type="number" id="edit-price" step="0.01" />
            </label>
          </div>
          <label>
            Link di prenotazione (Opzionale)
            <input type="url" id="edit-booking-link" placeholder="https://..." />
          </label>
          <label>
            Numero di Telefono/WhatsApp (Opzionale)
            <input type="text" id="edit-phone" placeholder="+39 333 1234567" />
          </label>
          <label>
            Tipo struttura
            <input type="text" id="edit-type" disabled />
          </label>
          <label>
            Stato annuncio
            <select id="edit-status">
              <option value="draft">Bozza</option>
              <option value="published">Pubblicato</option>
            </select>
          </label>
          <label>
            Carica nuove foto (opzionale)
            <input type="file" id="edit-photos-input" accept="image/*" multiple />
            <span class="small-label">La prima nuova foto sostituisce la copertina.</span>
          </label>
          <button type="submit" class="btn btn-primary btn-full">Salva modifiche</button>
        </form>
        <p id="edit-message" class="small-label"></p>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>¬© 2025 B&Brother‚Äôs ‚Äì Gestione Affitti Brevi a Roma. Tutti i diritti riservati.</p>
      <p>WhatsApp: +39 334 507 1226 ¬∑ Email: a.paolino0104@gmail.com</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://qmsgcpkxdkijsxyvhuog.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtc2djcGt4ZGtpanN4eXZodW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjQ1MzcsImV4cCI6MjA3ODkwMDUzN30.husS5qI2XxYqovnx3QX-EPFPca4SPWRQQo9rHM8NLEE";
    const PHOTO_BUCKET = "property-photos";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
  <script>
    function publicUrlFromPath(path) {
      if (!path) return null;
      if (path.startsWith("http")) return path;
      const { data } = supabaseClient.storage.from(PHOTO_BUCKET).getPublicUrl(path);
      return data?.publicUrl || null;
    }

    function getStoragePathFromUrl(url) {
      try {
        const parsed = new URL(url);
        const segments = parsed.pathname.split("/").filter(Boolean);
        const objectIndex = segments.findIndex((s) => s === "object");
        if (objectIndex !== -1 && segments.length > objectIndex + 2) {
          return segments.slice(objectIndex + 2).join("/");
        }
      } catch (e) {
        console.warn("Impossibile derivare il path dello storage", e);
      }
      return url;
    }

    async function getCurrentUser() {
      const { data, error } = await supabaseClient.auth.getUser();
      if (error || !data.user) {
        window.location.href = "login.html";
        return null;
      }
      return data.user;
    }

    const params = new URLSearchParams(window.location.search);
    const propertyId = params.get("id");
    let currentUser = null;
    let currentProperty = null;

    async function loadRooms(parentId) {
      const roomsList = document.getElementById("rooms-list");
      roomsList.innerHTML = "Caricamento stanze...";

      const { data, error } = await supabaseClient
        .from("properties")
        .select("*")
        .eq("parent_id", parentId)
        .order("title");

      if (error) {
        roomsList.innerHTML = "Errore caricamento stanze: " + error.message;
        return;
      }

      if (!data || data.length === 0) {
        roomsList.innerHTML = "<p>Nessuna stanza creata.</p>";
        return;
      }

      roomsList.innerHTML = data.map(room => `
        <div class="listing-card" style="padding: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0;">${room.title}</h4>
            <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                ${room.guests ? room.guests + " ospiti" : ""} ‚Ä¢ ${room.status}
            </div>
            <a href="area-proprietari-modifica.html?id=${room.id}" class="btn btn-outline btn-small">Modifica</a>
        </div>
      `).join("");
    }

    let sortableInstance = null;

    function renderOwnerGallery(photos, property) {
      const gallery = document.getElementById("edit-photos");
      if (!photos || photos.length === 0) {
        gallery.innerHTML = "<p class=\"small-label\">Nessuna foto caricata. Aggiungine di nuove qui sotto.</p>";
        return;
      }

      // Create Grid Container
      gallery.innerHTML = `<div id="gallery-grid" class="gallery-sortable-grid"></div>`;
      const grid = document.getElementById("gallery-grid");

      // Populate Grid
      grid.innerHTML = photos.map(p => `
        <div class="gallery-item" data-id="${p.id}" data-path="${p.path}">
          <img src="${p.url}" alt="Foto" loading="lazy">
          ${p.isCover ? '<span class="gallery-item-badge">Copertina</span>' : ''}
          <div class="gallery-item-actions">
            ${!p.isCover ? `
              <button type="button" class="btn btn-outline btn-small" style="width:100%; font-size:11px;" onclick="setCoverPhoto('${p.id}', '${p.url}', currentProperty)">Usa come copertina</button>
              <button type="button" class="btn btn-outline btn-small" style="width:100%; font-size:11px; color:#e11d48; border-color:#e11d48;" onclick="deletePhoto('${p.id}', '${p.path}')">Elimina</button>
            ` : `
               <button type="button" class="btn btn-outline btn-small" style="width:100%; font-size:11px; color:#e11d48; border-color:#e11d48;" onclick="deletePhoto('${p.id}', '${p.path}')">Elimina</button>
            `}
          </div>
        </div>
      `).join("");

      // Initialize Sortable
      if (sortableInstance) sortableInstance.destroy();
      sortableInstance = new Sortable(grid, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: function (evt) {
          // Drag ended, order updated in DOM
        }
      });
    }

    // Expose functions globally for inline onclick
    window.setCoverPhoto = setCoverPhoto;
    window.deletePhoto = deletePhoto;
    // Note: currentProperty is global in this script scope

    async function loadExistingPhotos(property) {
      const gallery = document.getElementById("edit-photos");
      gallery.innerHTML = "<p class=\"small-label\">Caricamento foto...</p>";
      const { data, error } = await supabaseClient
        .from("property_photos")
        .select("*")
        .eq("property_id", property.id)
        .order("sort_order", { ascending: true })
        .order("created_at", { ascending: true });

      if (error) {
        gallery.innerHTML =
          "<p>Errore nel recupero delle foto. Verifica che il bucket property-photos consenta a utenti autenticati di leggere e caricare.</p>";
        return;
      }

      const photos = (data || []).map((item) => {
        return {
          id: item.id,
          url: publicUrlFromPath(item.path),
          isCover: item.is_cover,
          path: item.path,
        };
      });

      // We no longer manually push the 'cover' from property blob if photos exist in DB, 
      // relying on DB photos as source of truth. 
      // But if DB is empty and property has a cover url from old system, we might miss it.
      // However, for editing we prefer the `property_photos` table.

      renderOwnerGallery(photos, property);
    }

    async function setCoverPhoto(photoId, photoUrl, property) {
      if (!photoId || !property) return;
      const msg = document.getElementById("edit-message");
      msg.textContent = "Aggiornamento della copertina...";

      const { error: resetError } = await supabaseClient
        .from("property_photos")
        .update({ is_cover: false })
        .eq("property_id", property.id);

      if (resetError) {
        msg.textContent = "Errore durante l'aggiornamento della copertina: " + resetError.message;
        return;
      }

      const { error: coverError } = await supabaseClient
        .from("property_photos")
        .update({ is_cover: true })
        .eq("id", photoId);

      if (coverError) {
        msg.textContent = "Errore durante il salvataggio della copertina: " + coverError.message;
        return;
      }

      await supabaseClient.from("properties").update({ cover_photo_url: photoUrl }).eq("id", property.id);
      property.cover_photo_url = photoUrl;
      msg.textContent = "Copertina aggiornata.";
      loadExistingPhotos(property);
    }

    async function deletePhoto(photoId, photoPath) {
      if (!confirm("Sei sicuro di voler eliminare questa foto?")) return;

      const toDeletePath = photoPath?.startsWith("http") ? getStoragePathFromUrl(photoPath) : photoPath;

      if (toDeletePath) {
        const { error: storageError } = await supabaseClient.storage.from(PHOTO_BUCKET).remove([toDeletePath]);
        if (storageError) {
          alert("Errore nell'eliminazione dallo storage: " + storageError.message);
          return;
        }
      }

      if (photoId && photoId !== "cover") {
        const { error: dbError } = await supabaseClient.from("property_photos").delete().eq("id", photoId);
        if (dbError) {
          alert("Foto rimossa dallo storage ma non dal database: " + dbError.message);
        }
      }

      // If it was cover, we might want to warn or unset property cover? 
      // For now, reload handles display.
      loadExistingPhotos(currentProperty);
    }

    async function savePhotoOrder() {
      if (!sortableInstance) return;
      const order = sortableInstance.toArray(); // Array of data-id
      if (!order || order.length === 0) return;

      const updates = order.map((id, index) => ({
        id: id,
        sort_order: index,
        // we need to include property_id to update? No, ID is primary key.
      }));

      // Supabase upsert/update by ID
      // We can do Promise.all or a single upsert if API supports it for customized columns
      // Standard supabase-js update expects a filter.
      // We will loop for now, or use upsert if we had all fields. 
      // Efficient way: create a stored procedure or just loop. Loop is fine for < 50 photos.

      for (let i = 0; i < order.length; i++) {
        await supabaseClient.from("property_photos").update({ sort_order: i }).eq("id", order[i]);
      }
    }

    async function loadProperty() {
      if (!propertyId) {
        document.getElementById("prop-name").textContent = "ID propriet√† non valido";
        return;
      }

      const { data, error } = await supabaseClient
        .from("properties")
        .select("*")
        .eq("id", propertyId)
        .eq("owner_id", currentUser.id)
        .single();

      if (error || !data) {
        document.getElementById("prop-name").textContent = "Propriet√† non trovata";
        return;
      }

      currentProperty = data;
      document.getElementById("prop-name").textContent = data.title || "Propriet√†";
      document.getElementById("page-title").textContent = data.title || "Modifica propriet√†";
      document.getElementById("edit-title").value = data.title || "";
      document.getElementById("edit-zone").value = data.zone || "";
      document.getElementById("edit-short").value = data.short_description || "";
      document.getElementById("edit-full").value = data.full_description || "";
      document.getElementById("edit-guests").value = data.guests || "";
      document.getElementById("edit-price").value = data.base_price || "";
      document.getElementById("edit-booking-link").value = data.booking_link || "";
      document.getElementById("edit-phone").value = data.phone_number || "";
      document.getElementById("edit-type").value = data.property_type === "guest_house" ? "Guest House" :
        data.property_type === "room" ? "Stanza" : "Appartamento";
      document.getElementById("edit-status").value = data.status || "draft";

      // If Guest House, show rooms section and hide guests input
      if (data.property_type === "guest_house") {
        document.getElementById("rooms-section").style.display = "block";
        document.getElementById("btn-add-room").href = `area-proprietari-nuova.html?parent_id=${data.id}`;
        document.getElementById("edit-guests").closest("label").style.display = "none";
        loadRooms(data.id);
      } else {
        document.getElementById("rooms-section").style.display = "none";
        document.getElementById("edit-guests").closest("label").style.display = "block";
      }

      loadExistingPhotos(data);
    }

    async function handleEditSubmit(e) {
      e.preventDefault();
      if (!currentProperty) return;
      const msg = document.getElementById("edit-message");
      msg.textContent = "Aggiornamento in corso...";

      // 1. Save Text Fields
      const title = document.getElementById("edit-title").value;
      const zone = document.getElementById("edit-zone").value;
      const shortDesc = document.getElementById("edit-short").value;
      const fullDesc = document.getElementById("edit-full").value;
      const guests = parseInt(document.getElementById("edit-guests").value || "0", 10);
      const price = parseFloat(document.getElementById("edit-price").value || "0");
      const bookingLink = document.getElementById("edit-booking-link").value;
      const phoneNumber = document.getElementById("edit-phone").value;
      const status = document.getElementById("edit-status").value;
      const newPhotos = Array.from(document.getElementById("edit-photos-input").files || []);

      const { error: updateError } = await supabaseClient
        .from("properties")
        .update({
          title,
          zone,
          booking_link: bookingLink,
          phone_number: phoneNumber,
          short_description: shortDesc,
          full_description: fullDesc,
          guests,
          base_price: price,
          status,
        })
        .eq("id", currentProperty.id);

      if (updateError) {
        msg.textContent = "Errore durante il salvataggio: " + updateError.message;
        return;
      }

      // 2. Save Photo Order
      if (sortableInstance) {
        await savePhotoOrder();
      }

      // 3. Upload New Photos
      if (newPhotos.length > 0) {
        let coverUrl = null;
        const failedUploads = [];
        const { count } = await supabaseClient
          .from("property_photos")
          .select("id", { count: "exact", head: true })
          .eq("property_id", currentProperty.id);
        const offset = count || 0;

        // Note: we don't reset is_cover here unless the user explicitly chose one? 
        // Or if it's the very first photo ever.
        // Let's keep logic simple: push new photos to end.

        for (let i = 0; i < newPhotos.length; i++) {
          const file = newPhotos[i];
          const path = `properties/${currentProperty.id}/${Date.now()}-${i}-${file.name}`;
          const { error: uploadError } = await supabaseClient.storage
            .from(PHOTO_BUCKET)
            .upload(path, file, { cacheControl: "3600", upsert: false, contentType: file.type });

          if (uploadError) {
            failedUploads.push(`${file.name}: ${uploadError.message}`);
            continue;
          }

          const { error: insertError } = await supabaseClient.from("property_photos").insert({
            property_id: currentProperty.id,
            path,
            is_cover: (offset === 0 && i === 0), // If no photos existed, first one is cover
            sort_order: offset + i,
          });

          if (insertError) {
            failedUploads.push(`${file.name}: ${insertError.message}`);
            continue;
          }

          if (offset === 0 && i === 0) {
            coverUrl = publicUrlFromPath(path);
          }
        }

        if (coverUrl) {
          await supabaseClient.from("properties").update({ cover_photo_url: coverUrl }).eq("id", currentProperty.id);
          currentProperty.cover_photo_url = coverUrl;
        }

        if (failedUploads.length > 0) {
          msg.textContent =
            "Modifica salvata ma alcune foto non sono state caricate: " +
            failedUploads.join("; ");
        }
      }

      if (!msg.textContent || msg.textContent === "Aggiornamento in corso...") {
        msg.textContent = "Annuncio aggiornato con successo!";
      }

      document.getElementById("edit-photos-input").value = "";
      await loadProperty();
    }

    (async () => {
      currentUser = await getCurrentUser();
      if (!currentUser) return;
      if (!propertyId) {
        document.getElementById("prop-name").textContent = "ID propriet√† non valido";
        return;
      }
      document.getElementById("edit-property-form").addEventListener("submit", handleEditSubmit);
      loadProperty();
    })();
  </script>
</body>

</html>